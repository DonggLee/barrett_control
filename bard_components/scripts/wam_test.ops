
import("bard_components")

import("kdl_typekit")

import("rtt_sensor_msgs")
import("rtt_trajectory_msgs")
import("rtt_geometry_msgs")
import("rtt_bard_msgs")

// Set up TF
import("rtt_tf")
loadComponent("tf","rtt_tf::RTT_TF")
tf.configure()
tf.start()

//// Set up left WAM + Controller
///////////////////////////////////////////////////////////////////////////////
// Create WAM /////////////////////////////////////////////////////////////////
loadComponent("wam_left","bard_components::WAM")
setActivity("wam_left",0.001,HighestPriority,ORO_SCHED_RT)

// Load properties from rosparam
loadService("wam_left","rosparam")
wam_left.rosparam.refreshProperties()

// Connect WAM state to ROS topic
stream("wam_left.joint_state_out", ros.topic("wam_rtt/wam_left/joint_states")) 

///////////////////////////////////////////////////////////////////////////////
// Create multiplexer /////////////////////////////////////////////////////////
loadComponent("left_mux","bard_components::ControllerMux")
setActivity("left_mux",0,HighestPriority,ORO_SCHED_RT)
stream("left_mux.joint_state_out", ros.topic("wam_rtt/left_mux/joint_states")) 

// Configure parameters
loadService("left_mux","rosparam")
left_mux.rosparam.refreshProperties()
left_mux.configure()

// Connect mux to wam
connect("wam_left.positions_out","left_mux.positions_in",ConnPolicy())
connect("left_mux.torques_out","wam_left.torques_in",ConnPolicy())


///////////////////////////////////////////////////////////////////////////////
// Create trivial controller //////////////////////////////////////////////////
/*
loadComponent("left_trivial","bard_components::controllers::Trivial")
setActivity("left_trivial",0.001,HighestPriority,ORO_SCHED_RT)

connect("wam_left.positions_out","left_trivial.positions_in",ConnPolicy())

// Configure parameters
loadService("left_trivial","rosparam")
left_trivial.rosparam.refreshProperties()
left_trivial.configure()

// Connect controller to mux
left_mux.load("trivial")
connect("left_trivial.torques_out","left_mux.trivial",ConnPolicy())
*/

///////////////////////////////////////////////////////////////////////////////
// Create joint PID controller ////////////////////////////////////////////////

loadComponent("left_joint_pid","bard_components::controllers::Trivial")
setActivity("left_joint_pid",0.001,HighestPriority,ORO_SCHED_RT)

connect("wam_left.positions_out","left_joint_pid.positions_in",ConnPolicy())

// Configure parameters
loadService("left_joint_pid","rosparam")
left_joint_pid.rosparam.refreshProperties()
left_joint_pid.configure()

// Connect controller to mux
left_mux.load("joint_pid")
connect("left_joint_pid.torques_out","left_mux.trivial",ConnPolicy())

///////////////////////////////////////////////////////////////////////////////
// Create gravity controller //////////////////////////////////////////////////
loadComponent("left_grav","bard_components::controllers::GravityCompensation")
setActivity("left_grav",0,HighestPriority,ORO_SCHED_RT)

connect("wam_left.positions_out","left_grav.positions_in",ConnPolicy())

// Configure parameters
loadService("left_grav","rosparam")
left_grav.rosparam.refreshProperties()
left_grav.configure()

// Connect controller to mux
left_mux.load("gravity")
connect("left_grav.torques_out","left_mux.gravity",ConnPolicy())

///////////////////////////////////////////////////////////////////////////////
// Create cartesian wrench controller /////////////////////////////////////////
/*
loadComponent("left_wrench","bard_components::controllers::CartesianWrench")
setActivity("left_wrench",0.001,HighestPriority,ORO_SCHED_RT)
connectPeers("tf","left_wrench")

connect("wam_left.positions_out","left_wrench.positions_in",ConnPolicy())

// Configure parameters
loadService("left_wrench","rosparam")
left_wrench.rosparam.refreshProperties()
left_wrench.configure()

// Connect controller to mux
left_mux.load("wrench")
connect("left_wrench.torques_out","left_mux.wrench",ConnPolicy())
*/

///////////////////////////////////////////////////////////////////////////////
// Create cartesian pose  controller //////////////////////////////////////////
loadComponent("left_pose","bard_components::controllers::CartesianPose")
setActivity("left_pose",0,HighestPriority,ORO_SCHED_RT)
connectPeers("tf","left_pose")

connect("wam_left.positions_out","left_pose.positions_in",ConnPolicy())

// Configure parameters
loadService("left_pose","rosparam")
left_pose.rosparam.refreshProperties()
left_pose.configure()

// Connect controller to mux
left_mux.load("pose")
connect("left_pose.torques_out","left_mux.pose",ConnPolicy())
connect("left_pose.positions_out","left_joint_pid.positions_des_in",ConnPolicy())

// Connect WAM state to ROS topic
stream("left_pose.joint_state_out", ros.topic("wam_rtt/left_pose/joint_states")) 

///////////////////////////////////////////////////////////////////////////////
// Start Things ///////////////////////////////////////////////////////////////
wam_left.configure()
wam_left.start()

// Start the controllers
left_grav.start()
left_joint_pid.start()
left_pose.start()
//left_wrench.start()

// Start the multiplexer
left_mux.disable()
left_mux.start()
left_mux.toggleControllers(strings("gravity"),strings())
//left_mux.toggleControllers(strings("pose"),strings())
//left_mux.toggleControllers(strings("trivial"),strings("gravity"))
//left_mux.toggleControllers(strings("gravity"),strings("trivial"))
